{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./app/YoutubeParser.lsc","webpack:///./app/appMain.lsc","webpack:///./app/logging.lsc","webpack:///external \"chrome-native-messaging\"","webpack:///external \"crypto\"","webpack:///external \"fs\"","webpack:///external \"node-mpv\"","webpack:///external \"p-finally\"","webpack:///external \"path\"","webpack:///external \"qs\"","webpack:///external \"url\"","webpack:///external \"winston\"","webpack:///external \"winston-daily-rotate-file\""],"names":["validHost","validPathname","validId","validStartAt","URL","process","require","YouTubeURLParser","constructor","url","parser","href","parsedURL","query","search","ignoreQueryPrefix","id","exec","pathname","addQueryPrefix","startAt","_startAt","hour","Number","minute","second","isValid","test","hostname","getId","getCanonicalURL","getEmbeddingURL","getShortURL","getStartAtSecond","getThumbnailURL","getIframe","options","allowFullScreen","undefined","frameBorder","responsive","noCookie","domain","options2","path","join","getMpvBinaryDir","nativeMessage","Input","Transform","messageHandler","Output","cookies","mpvOptions","push","done","ytParser","createCookiesFile","createNewMpvInstance","mpvPlayer","on","error","start","then","volume","load","cleanYoutubeUrl","videoStartPosition","goToPosition","startMPVpaused","pause","catch","logger","mpvAPI","binary","mpvPath","socket","generateRandomString","cookiesFilePath","generateScriptOpts","oscStyle","alwaysOnTop","generateYTvideoQualityOpts","videoQuality","generateMPVwindowSizeOpts","defaultMpvWindowSize","randomBytes","toString","osc","writeFileSync","cwd","stdin","pipe","input","transform","output","stdout","winston","transports","DailyRotateFile","filename","dirname","datePattern","maxSize","maxFiles","fileTransport","Console","createLogger","level","format","prettyPrint"],"mappings":"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","file":"appMain-compiled.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./app/appMain.lsc\");\n","/*****\r\n* This is a forked version of '@iktakahiro/youtube-url-parser'\r\n*/\r\nimport { stringify, parse } from \"qs\"\r\n\r\nconst validHost = /^(www.youtube.com|youtu.be)$/\r\nconst validPathname = /^.*\\/([a-zA-Z0-9_-]{11})$/\r\nconst validId = /^([a-zA-Z0-9_-]{11})$/\r\nconst validStartAt = /^((\\d{1,2})h)?((\\d{1,2})m)?((\\d{1,2})s)?$/\r\nconst URL = process ? require('url').URL : URL\r\n\r\nexport class YouTubeURLParser {\r\n    constructor(url: string) {\r\n\r\n        const parser = new URL(url)\r\n        parser.href = url\r\n        this.parsedURL = parser\r\n\r\n        const query = parse(this.parsedURL.search, { ignoreQueryPrefix: true })\r\n        this.id = (validPathname.exec(this.parsedURL.pathname) || [])[1] || null\r\n        if (this.id === null) {\r\n            this.id = (validId.exec(query[\"v\"]) || [])[1] || null\r\n        }\r\n        delete query[\"watch\"]\r\n        this.search = stringify(query, { addQueryPrefix: false })\r\n\r\n        const startAt = (validStartAt.exec(query[\"t\"]) || []) || null\r\n        if (startAt) {\r\n            this._startAt = {\r\n                hour: Number(startAt[2]) || 0,\r\n                minute: Number(startAt[4]) || 0,\r\n                second: Number(startAt[6]) || 0,\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Checks whether URL is valid or invalid.\r\n     */\r\n    isValid(): boolean {\r\n        if (!validHost.test(this.parsedURL.hostname)) {\r\n            return false\r\n        }\r\n        if (this.id === null) {\r\n            return false\r\n        }\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * Returns the id of a YouTube video.\r\n     * @return {string | null} id\r\n     */\r\n    getId(): string | null {\r\n        if (!this.isValid()) {\r\n            return null\r\n        }\r\n        return this.id\r\n    }\r\n\r\n    /**\r\n     * Return the canonical URL of a YouTube video.\r\n     * @return {string | null} URL\r\n     */\r\n    getCanonicalURL(): string | null {\r\n        if (!this.isValid()) {\r\n            return null\r\n        }\r\n        return `https://www.youtube.com/watch?v=${this.id}&${this.search}`\r\n    }\r\n\r\n    /**\r\n     * Return the embedding URL of a YouTube video.\r\n     * @return {string | null} URL\r\n     */\r\n    getEmbeddingURL(): string | null {\r\n        if (!this.isValid()) {\r\n            return null\r\n        }\r\n        return `https://www.youtube.com/embed/${this.id}?${this.search}`\r\n    }\r\n\r\n    /**\r\n     * Return the short URL of a YouTube video.\r\n     * @return {string | null} URL\r\n     */\r\n    getShortURL(): string | null {\r\n        if (!this.isValid()) {\r\n            return null\r\n        }\r\n        return `https://youtu.be/${this.id}?${this.search}`\r\n    }\r\n\r\n    /**\r\n     * Return the start time (second) of a YouTube video.\r\n     * @return {number} second\r\n     */\r\n    getStartAtSecond(): number | null {\r\n        if (!this.isValid()) {\r\n            return null\r\n        }\r\n        return this._startAt.hour * 60 * 60 + this._startAt.minute * 60 + this._startAt.second\r\n    }\r\n\r\n    /**\r\n     * Return the thumbnail URL of a YouTube video.\r\n     * @return {string | null} ULR\r\n     */\r\n    getThumbnailURL(): string | null {\r\n        if (!this.isValid()) {\r\n            return null\r\n        }\r\n        return `https://img.youtube.com/vi/${this.id}/0.jpg`\r\n    }\r\n\r\n    /**\r\n     * Return the HTML string for embedding.\r\n     * @return {string | null} HTML string\r\n     */\r\n    getIframe(options): string | null {\r\n        if (!this.isValid()) {\r\n            return null\r\n        }\r\n\r\n        // set default values\r\n        options2 = {\r\n            allowFullScreen: (options[\"allowFullScreen\"] === undefined) ? true : options.allowFullScreen,\r\n            frameBorder: (options[\"frameBorder\"] === undefined) ? 0 : options.frameBorder,\r\n            responsive: (options[\"responsive\"] === undefined) ? true : options.responsive,\r\n            noCookie: (options[\"noCookie\"] === undefined) ? false : options.noCookie,\r\n        }\r\n\r\n        const domain = options2.noCookie ? \"www.youtube-nocookie.com\" : \"www.youtube.com\"\r\n        return `<div class=\"embed-responsive embed-responsive-16by9\">\r\n        <iframe class=\"embed-responsive-item\" type=\"text/html\"\r\n        src=\"https://${domain}/embed/${this.id}?rel=0&amp;start=${this.getStartAtSecond() || 0}\"\r\n        frameborder=\"${options2.frameBorder}\" ${options2.allowFullScreen ? \"allowfullscreen\" : \"\"}></iframe>\r\n        </div>`\r\n    }\r\n}\r\n\r\n","import path from 'path'\r\nimport fs from 'fs'\r\nimport crypto from 'crypto'\r\n\r\nimport mpvAPI from 'node-mpv'\r\nimport nativeMessage from 'chrome-native-messaging'\r\nimport pFinally from 'p-finally'\r\n// import { YouTubeURLParser } from '@iktakahiro/youtube-url-parser'\r\nimport { YouTubeURLParser } from './YoutubeParser.lsc'\r\nimport { logger } from './logging.lsc'\r\n\r\ntype MpvOptions = {\r\n  volume: number,\r\n  alwaysOnTop: boolean,\r\n  videoQuality: string,\r\n  defaultMpvWindowSize: string,\r\n  dontLetYTpageVideoAutoLoad: boolean,\r\n  oscStyle: string,\r\n  startMPVpaused: boolean\r\n};\r\ntype NativeMessage = {\r\n  url: string,\r\n  cookies: string,\r\n  mpvOptions: MpvOptions\r\n};\r\n\r\nmpvPath = path.join(getMpvBinaryDir(), 'mpv.exe')\r\ncookiesFilePath = path.join(getMpvBinaryDir(), 'cookies.txt')\r\ninput = new nativeMessage.Input()\r\ntransform = new nativeMessage.Transform(messageHandler)\r\noutput = new nativeMessage.Output()\r\n\r\n/*****\r\n* Based on https://github.com/winneon/watch-with-mpv/blob/master/native/native.js\r\n*/\r\nmessageHandler({url, cookies, mpvOptions}: NativeMessage, push, done):void ->\r\n  ytParser = new YouTubeURLParser(url)\r\n  if !ytParser.isValid(url): return\r\n  createCookiesFile(cookies)\r\n  mpvPlayer = createNewMpvInstance(mpvOptions)\r\n  mpvPlayer.on('crashed', () -> logger.error('mpv crashed'))\r\n\r\n  pFinally(\r\n    mpvPlayer.start()\r\n      .then(() -> mpvPlayer.volume(mpvOptions.volume))\r\n      .then(() -> mpvPlayer.load(cleanYoutubeUrl(url)))\r\n      .then(() ->\r\n        videoStartPosition = ytParser.getStartAtSecond()\r\n        // If it's 10 seconds or less then it's not worth skipping ahead\r\n        if videoStartPosition > 10:\r\n          mpvPlayer.goToPosition(videoStartPosition)\r\n      )\r\n      .then(() ->\r\n        if mpvOptions.startMPVpaused: mpvPlayer.pause()\r\n      )\r\n    , done\r\n  )\r\n  .catch(logger.error)\r\n\r\ncreateNewMpvInstance(mpvOptions:MpvOptions) ->\r\n  new mpvAPI(\r\n    {\r\n      binary: mpvPath,\r\n      socket: `\\\\\\\\.\\\\pipe\\\\mpvserver${ generateRandomString() }`,\r\n    },\r\n    [\r\n      '--cookies',\r\n      `--cookies-file=\"${ cookiesFilePath }\"`,\r\n      `--ytdl-raw-options=cookies=\"${ cookiesFilePath }\"`,\r\n        generateScriptOpts(mpvOptions.oscStyle),\r\n        mpvOptions.alwaysOnTop ? `--ontop` : ``,\r\n        generateYTvideoQualityOpts(mpvOptions.videoQuality),\r\n        generateMPVwindowSizeOpts(mpvOptions.defaultMpvWindowSize)\r\n    ]\r\n  )\r\n\r\ngenerateRandomString():string ->\r\n  crypto.randomBytes(8).toString('hex')\r\n\r\ngenerateMPVwindowSizeOpts(defaultMpvWindowSize:string):string ->\r\n  defaultMpvWindowSize === 'off' ? `` : `--autofit=${ defaultMpvWindowSize }`\r\n\r\ngenerateYTvideoQualityOpts(videoQuality:string):string ->\r\n  videoQuality === 'original' ? `` : `--ytdl-format=${ videoQuality }`\r\n\r\ngenerateScriptOpts(osc:string):string ->\r\n  if osc === 'box': return `--script-opts=osc-layout=box,osc-scalewindowed=1.2`\r\n  `--script-opts=osc-scalewindowed=1.2`\r\n\r\ncreateCookiesFile(cookies:string):string ->\r\n  fs.writeFileSync(cookiesFilePath, cookies)\r\n\r\n/*****\r\n* I had some issues with mpv where if the youtube url had stuff at the end of it -\r\n* e.g. https://www.youtube.com/watch?v=WUC863mOtTc&feature=youtu.be&t=2398, then\r\n* mpv would seem to ignore any command line flags after the url, so gonna clean it.\r\n*/\r\ncleanYoutubeUrl(url:string):string ->\r\n  parser = new YouTubeURLParser(url)\r\n  `https://www.youtube.com/watch?v=${ parser.getId() }`\r\n\r\n/*****\r\n* If we're debugging the non-built version, our cwd will be the project\r\n* dir, but if we're debugging the built version, the cwd will just\r\n* be process.cwd()\r\n*/\r\ngetMpvBinaryDir():boolean ->\r\n  if ISDEV && !IS_BUILD_DEBUG: return'debug'\r\n  process.cwd()\r\n\r\nprocess.stdin.pipe(input).pipe(transform).pipe(output).pipe(process.stdout)\r\nprocess.on('unhandledRejection', logger.error)\r\nprocess.on('uncaughtException', logger.error)\r\n","import winston from 'winston'\r\nimport 'winston-daily-rotate-file'\r\n\r\nfileTransport = new (winston.transports.DailyRotateFile)({\r\n  filename: 'yt-open-in-mpv-native-client-%DATE%.log',\r\n  dirname: ISDEV && !IS_BUILD_DEBUG? 'debug' : '.'\r\n  datePattern: 'YYYY-MM-DD-HH',\r\n  maxSize: '20m',\r\n  maxFiles: 5\r\n})\r\n\r\ntransports = [\r\n  fileTransport,\r\n]\r\n\r\nif ISDEV: transports.push(new winston.transports.Console())\r\n\r\nlogger = winston.createLogger({\r\n  level: if ISDEV: 'debug' else: 'error',\r\n  format: if ISDEV: winston.format.prettyPrint() else: winston.format.json()\r\n  transports\r\n})\r\n\r\nexport {\r\n  logger\r\n}\r\n","module.exports = require(\"chrome-native-messaging\");","module.exports = require(\"crypto\");","module.exports = require(\"fs\");","module.exports = require(\"node-mpv\");","module.exports = require(\"p-finally\");","module.exports = require(\"path\");","module.exports = require(\"qs\");","module.exports = require(\"url\");","module.exports = require(\"winston\");","module.exports = require(\"winston-daily-rotate-file\");"],"sourceRoot":""}